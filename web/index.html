<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description"
          content="Web application to redirect incoming log messages to Web UI.">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, user-scalable=no">
    <title>Remote Console</title>
    <style>
        :root {
            --space: 5px;
        }

        HTML, BODY {
            background-color: black;
            box-sizing: border-box;
            color: green;
            margin: 0;
        }

        H1 {
            font-size: larger;
        }

        HEADER {
            align-items: center;
            display: flex;
            justify-content: space-between;
            padding: var(--space);
        }

        #output {
            padding: var(--space);
        }

        .disconnected {
            opacity: 0.5;
        }
    </style>
    <script>
        // VARS
        const CLASS_DISCONNECTED = 'disconnected';
        const ID_BTN_CONNECT = 'btnConnect';
        const ID_BTN_TEST = 'btnTest';
        const ID_DISPLAY = 'output';
        const MAX_ITEMS = 64;

        // FUNCS
        function doSocketOff() {
            document.getElementById(ID_BTN_CONNECT).disabled = false;
            document.getElementById(ID_BTN_TEST).disabled = true;
            document.getElementById(ID_DISPLAY).classList.add(CLASS_DISCONNECTED);
            document.querySelector('h1').classList.add(CLASS_DISCONNECTED);
        }

        function doSocketOn() {
            document.getElementById(ID_BTN_CONNECT).disabled = true;
            document.getElementById(ID_BTN_TEST).disabled = false;
            document.getElementById(ID_DISPLAY).classList.remove(CLASS_DISCONNECTED);
            document.querySelector('h1').classList.remove(CLASS_DISCONNECTED);
        }

        function onAbout() {
            window.open('https://github.com/flancer64/spa-remote-console', '_blank');
        }

        function onConnect() {
            socketOpen();
        }

        function onTest() {
            navigator.sendBeacon('/log/', 'Test message from Remote Console to itself.');
        }

        function socketOpen() {
            // FUNCS
            function composeUrl() {
                const hostname = location.hostname;
                const port = ((location.port === '443') || (location.port === ''))
                    ? '' : `:${location.port}`;
                const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
                return `${proto}://${hostname}${port}/`;
            }

            function onOpen() {
                doSocketOn();
            }

            function onError(e) {
                console.error(e);
            }

            function onClose() {
                doSocketOff();
            }

            /**
             * Display log message on UI.
             * @param {MessageEvent} evt
             */
            function onMessage(evt) {
                // extract log message form the event
                const log = evt?.data;
                const elLog = document.createElement('div');
                elLog.textContent = log;
                // get display root element
                const elRoot = document.getElementById(ID_DISPLAY);
                const total = elRoot.childElementCount;
                if (total === 0) {
                    // display is empty
                    elRoot.appendChild(elLog);
                } else {
                    // remove extra items (+1) from display to put new item
                    if (total >= MAX_ITEMS)
                        for (let i = 0; i <= (total - MAX_ITEMS); i++)
                            elRoot.removeChild(elRoot.lastChild);
                    // add new item to the first position
                    const elFirst = elRoot.firstChild;
                    elRoot.insertBefore(elLog, elFirst);
                }
            }

            // MAIN
            const url = composeUrl();
            const sock = new WebSocket(url);
            sock.addEventListener('open', onOpen);
            sock.addEventListener('error', onError);
            sock.addEventListener('close', onClose);
            sock.addEventListener('message', onMessage);
        }

        // MAIN
        document.addEventListener('DOMContentLoaded', socketOpen);
    </script>
</head>
<body>
<header>
    <h1 class="disconnected">Remote Console</h1>
    <div>
        <button onclick="onAbout()">About</button>
        <button id="btnTest" onclick="onTest()">Test</button>
        <button id="btnConnect" onclick="onConnect()">Connect</button>
    </div>
</header>
<main id="output" class="disconnected"></main>
</body>
</html>
